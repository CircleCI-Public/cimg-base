version: 2.1

orbs:
  bt: circleci/build-tools@2.6.3
  cimg: cci-dev/cimg@0.0.19
  docker: circleci/docker@0.5.10

dev-filters: &dev-filters
  branches:
    ignore: master

master-filters: &master-filters
  branches:
    only: master

lint-ignore-rules: &lint-ignore-rules
  DL3006,DL3007,DL3008,DL3015,SC1072,SC1090,SC2039,SC2143 # remove DL3006 later, it's an important one

commands:
  prepare-node-dockerfile-from-template:
    parameters:
      base-org-image-tag:
        type: string
      step-name:
        type: string
    steps:
      - run:
          name: <<parameters.step-name>>
          command: |
            version=<<parameters.base-org-image-tag>>

            sed -r -e 's!%%BASE_ORG_BASE_IMAGE_BASE_TAG%%!'"$version"'!g' \
              variant-node/Dockerfile.template > variant-node/Dockerfile

      - persist_to_workspace:
          root: ~/
          paths: project

workflows:
  monthly-cron:
    triggers:
      - schedule:
          cron: "0 0 2 * *"
          filters: *master-filters
    jobs:
      - docker/hadolint:
          name: lint-ubuntu-monthly
          dockerfile: ubuntu/Dockerfile
          ignore-rules: *lint-ignore-rules
          filters: *master-filters

      - cimg/build-test-deploy:
          name: ubuntu-monthly
          context: image-publishing
          dockerfile-path: ubuntu
          image-name: cimg/base
          image-tag: "$( date +%Y.%m )"
          extra-build-args: --pull
          goss-yaml-dir-path: ubuntu
          test-suite-name: ubuntu
          deploy: true
          publish-tags: stable,latest
          filters: *master-filters
          requires: [lint-ubuntu-monthly]
          post-steps:
            - prepare-node-dockerfile-from-template:
                step-name: Prepare monthly Node variant Dockerfile from template
                base-org-image-tag: "cimg/base:$( date +%Y.%m )"

      - docker/hadolint:
          name: lint-node-monthly
          pre-steps: [bt/install-ci-tools]
          checkout: false
          attach-workspace: true
          workspace-root: ~/
          dockerfile: variant-node/Dockerfile
          ignore-rules: *lint-ignore-rules
          filters: *master-filters

      - cimg/build-test-deploy:
          name: node-monthly
          context: image-publishing
          checkout: false
          attach-workspace: true
          workspace-root: ~/
          dockerfile-path: variant-node
          image-name: cimg/base
          image-tag: "$( date +%Y.%m )-node"
          extra-build-args: |
            --pull --build-arg NODE_VERSION=$(curl \
              --show-error --location --fail --retry 3 \
              https://api.github.com/repos/nodejs/node/releases | \
              grep "(LTS)" | head -n 1 | sed -E 's|.*Version ||' | cut -f1 -d" ")
          goss-yaml-dir-path: variant-node
          test-suite-name: variant-node
          deploy: true
          publish-tags: stable-node
          filters: *master-filters
          requires: [lint-node-monthly]

  commit-edge-dev:
    jobs:
      - docker/hadolint:
          name: lint-ubuntu-edge-dev
          dockerfile: ubuntu/Dockerfile
          ignore-rules: *lint-ignore-rules
          filters: *dev-filters

      - cimg/build-test-deploy:
          name: ubuntu-edge-dev
          context: image-publishing
          dockerfile-path: ubuntu
          image-name: ccitest/base
          image-tag: "$CIRCLE_BRANCH-${CIRCLE_SHA1:0:7}"
          extra-build-args: --pull
          goss-yaml-dir-path: ubuntu
          test-suite-name: ubuntu
          deploy: true
          publish-tags: latest
          filters: *dev-filters
          requires: [lint-ubuntu-edge-dev]
          post-steps:
            - prepare-node-dockerfile-from-template:
                step-name: Prepare ccitest/base Node variant Dockerfile from template
                base-org-image-tag: "ccitest/base:$CIRCLE_BRANCH-${CIRCLE_SHA1:0:7}"

      - docker/hadolint:
          name: lint-node-edge-dev
          pre-steps: [bt/install-ci-tools]
          checkout: false
          attach-workspace: true
          workspace-root: ~/
          dockerfile: variant-node/Dockerfile
          ignore-rules: *lint-ignore-rules
          filters: *dev-filters
          requires: [ubuntu-edge-dev]

      - cimg/build-test-deploy:
          name: node-edge-dev
          context: image-publishing
          checkout: false
          attach-workspace: true
          workspace-root: ~/
          dockerfile-path: variant-node
          image-name: ccitest/base
          image-tag: "$CIRCLE_BRANCH-${CIRCLE_SHA1:0:7}-node"
          extra-build-args: |
            --pull --build-arg NODE_VERSION=$(curl \
              --show-error --location --fail --retry 3 \
              https://api.github.com/repos/nodejs/node/releases | \
              grep "(LTS)" | head -n 1 | sed -E 's|.*Version ||' | cut -f1 -d" ")
          goss-yaml-dir-path: variant-node
          test-suite-name: variant-node
          deploy: true
          filters: *dev-filters
          requires: [lint-node-edge-dev]

  commit-edge-master:
    jobs:
      - docker/hadolint:
          name: lint-ubuntu-edge-master
          dockerfile: ubuntu/Dockerfile
          ignore-rules: *lint-ignore-rules
          filters: *master-filters

      - cimg/build-test-deploy:
          name: ubuntu-edge-master
          context: image-publishing
          dockerfile-path: ubuntu
          image-name: cimg/base
          image-tag: edge
          extra-build-args: --pull
          goss-yaml-dir-path: ubuntu
          test-suite-name: ubuntu
          deploy: true
          publish-tags: latest
          filters: *master-filters
          requires: [lint-ubuntu-edge-master]
          post-steps:
            - prepare-node-dockerfile-from-template:
                step-name: Prepare edge Node variant Dockerfile from template
                base-org-image-tag: cimg/base:edge

      - docker/hadolint:
          name: lint-node-edge-master
          pre-steps: [bt/install-ci-tools]
          checkout: false
          attach-workspace: true
          workspace-root: ~/
          dockerfile: variant-node/Dockerfile
          ignore-rules: *lint-ignore-rules
          filters: *master-filters
          requires: [ubuntu-edge-master]

      - cimg/build-test-deploy:
          name: node-edge-master
          context: image-publishing
          checkout: false
          attach-workspace: true
          workspace-root: ~/
          dockerfile-path: variant-node
          image-name: cimg/base
          image-tag: edge-node
          extra-build-args: |
            --pull --build-arg NODE_VERSION=$(curl \
              --show-error --location --fail --retry 3 \
              https://api.github.com/repos/nodejs/node/releases | \
              grep "(LTS)" | head -n 1 | sed -E 's|.*Version ||' | cut -f1 -d" ")
          goss-yaml-dir-path: variant-node
          test-suite-name: variant-node
          deploy: true
          filters: *master-filters
          requires: [lint-node-edge-master]
