version: 2.1

orbs:
  cimg: cci-dev/cimg@0.0.6

dev-filters: &dev-filters
  branches:
    ignore: master

master-filters: &master-filters
  branches:
    only: master

workflows:
  monthly-cron:
    triggers:
      - schedule:
          cron: "0 0 2 * *"
          filters: *master-filters
    jobs:
      - cimg/build-test-deploy:
          name: build-test-deploy-monthly-cron
          context: image-publishing
          dockerfile-path: ubuntu
          image-name: cimg/base
          image-tag: "${CIRCLE_SHA1:0:7}"
          extra-build-args: --pull
          goss-yaml-dir-path: ubuntu
          deploy: true
          publish-tag: "$( date +%Y.%m )"
          filters: *master-filters

      - cimg/build-test-deploy:
          name: build-test-deploy-monthly-cron-node
          context: image-publishing
          dockerfile-path: variant-node
          image-name: cimg/base
          image-tag: "${CIRCLE_SHA1:0:7}-node"
          extra-build-args: --pull
          goss-yaml-dir-path: variant-node
          deploy: true
          publish-tag: "$( date +%Y.%m )-node"
          filters: *master-filters

  commit-edge:
    jobs:
      # triggered by non-master branch commits
      - cimg/build-test-deploy:
          name: build-test-deploy-commit-edge-dev
          dockerfile-path: ubuntu
          image-name: cimg/base
          image-tag: "${CIRCLE_SHA1:0:7}"
          extra-build-args: --pull
          goss-yaml-dir-path: ubuntu
          filters: *dev-filters

      - cimg/build-test-deploy:
          name: build-test-deploy-commit-edge-dev-node
          dockerfile-path: variant-node
          image-name: cimg/base
          image-tag: "${CIRCLE_SHA1:0:7}-node"
          extra-build-args: --pull
          goss-yaml-dir-path: variant-node
          filters: *dev-filters

      # triggered by master branch commits
      - cimg/build-test-deploy:
          name: build-test-deploy-commit-edge-master
          context: image-publishing
          dockerfile-path: ubuntu
          image-name: cimg/base
          image-tag: "${CIRCLE_SHA1:0:7}"
          extra-build-args: --pull
          goss-yaml-dir-path: ubuntu
          deploy: true
          publish-tag: edge
          filters: *master-filters

      - cimg/build-test-deploy:
          name: build-test-deploy-commit-edge-master-node
          context: image-publishing
          dockerfile-path: variant-node
          image-name: cimg/base
          image-tag: "${CIRCLE_SHA1:0:7}-node"
          extra-build-args: --pull
          goss-yaml-dir-path: variant-node
          deploy: true
          publish-tag: edge-node
          filters: *master-filters
